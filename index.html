<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Geopolitical Risk Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 
  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
 
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a1929;
      color: #AAB7B8;
      overflow: hidden;
      height: 100vh;
    }
    .header {
      background: #0a1929;
      color: #FFFFFF;
      padding: 8px 16px;
      border-bottom: 1px solid #1e3a8a;
      font-size: 18px;
      font-weight: 600;
    }
    .metrics-bar {
      background: #0a1929;
      padding: 6px 16px;
      border-bottom: 1px solid #1e3a8a;
      display: flex;
      gap: 24px;
      font-size: 12px;
      overflow-x: auto;
    }
    .metric { display: flex; align-items: center; gap: 8px; white-space: nowrap; }
    .metric-value { font-weight: 600; color: #FFFFFF; }
    .main-container { display: flex; height: calc(100vh - 80px); }
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
 
    .sidebar {
      width: 250px;
      background: #0a1929;
      border-left: 1px solid #1e3a8a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 12px;
      border-bottom: 1px solid #1e3a8a;
      background: #0a1929;
    }
    .tabs { display: flex; gap: 4px; margin-bottom: 12px; flex-wrap: wrap; }
    .tab {
      padding: 4px 8px; border: 1px solid #374151; border-radius: 4px;
      background: transparent; color: #AAB7B8; font-size: 11px; cursor: pointer; transition: all 0.2s;
    }
    .tab.active { background: #1e3a8a; color: #FFFFFF; }
 
    .filter-section { margin-bottom: 12px; }
    .filter-label { font-size: 10px; color: #AAB7B8; margin-bottom: 6px; }
    .event-types { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
    .event-type-btn {
      padding: 3px 6px; border: 1px solid #374151; border-radius: 3px;
      background: transparent; color: #AAB7B8; font-size: 9px; cursor: pointer; transition: all 0.2s; text-align: left;
    }
    .event-type-btn.active { border-color: #1e3a8a; background: rgba(30, 58, 138, 0.2); }
    .event-counter { font-size: 9px; color: #6B7280; margin-top: 6px; }
    
 /* HIDE FILTER SECTION ON MOBILE */
@media (max-width: 768px) {
  .filter-section {
    display: none !important;
  }
}
    .events-content { flex: 1; overflow-y: auto; padding: 12px; }
 
    /* Standalone event cards (prevent merging/nesting) */
    .event-card {
      display: block !important;
      width: 100% !important;
      border: 1px solid #374151; border-radius: 6px;
      padding: 8px; margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s;
      background: transparent; box-sizing: border-box !important;
    }
    .event-card:hover { border-color: #1e3a8a; }
    .event-card > * { display: block; margin: 0; }
 
    .event-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px; }
    .event-type { font-size: 10px; font-weight: 600; color: #60A5FA; }
    .event-time { font-size: 9px; color: #6B7280; }
    .event-title { font-size: 11px; font-weight: 600; color: #FFFFFF; margin-bottom: 4px; line-height: 1.2; }
    .event-description { font-size: 10px; color: #AAB7B8; margin-bottom: 6px; line-height: 1.3; }
    .event-meta { display: flex; justify-content: space-between; align-items: center; font-size: 9px; }
    .country-name { color: #AAB7B8; }
    .risk-score { color: #F59E0B; font-weight: 600; }
    .event-impact { margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(107, 114, 128, 0.3); font-size: 9px; }
    .impact-label { color: #6B7280; }
    .impact-text { color: #F59E0B; font-weight: 500; }
    .loading, .no-events { text-align: center; padding: 20px; color: #6B7280; }
    .no-events { font-size: 12px; }
 
    /* Tabs content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .country-item, .resource-item {
      background: rgba(30, 58, 138, 0.1); border: 1px solid #374151; border-radius: 4px; padding: 8px; margin-bottom: 6px; cursor: pointer;
    }
    .country-item:hover, .resource-item:hover { border-color: #1e3a8a; }
    .item-name { font-size: 11px; font-weight: 600; color: #FFFFFF; margin-bottom: 2px; }
    .item-risk { font-size: 9px; display: flex; justify-content: space-between; }
    .risk-label { color: #6B7280; }
    .risk-value { font-weight: 600; }
 
    /* PULSE animation for country highlight */
    @keyframes country-pulse {
      0%, 100% { opacity: 1; filter: brightness(1.2); }
      50% { opacity: 0.7; filter: brightness(0.9); }
    }
    .country-pulse { animation: country-pulse 1s ease-in-out 3 !important; }
    .leaflet-interactive { transition: fill 0.3s ease, stroke 0.3s ease, opacity 0.3s ease, filter 0.3s ease; }

    /* ===================== RESPONSIVE DESIGN FOR MOBILE & LAPTOP ===================== */
    
    /* Mobile-first approach - Small screens (phones) */
    @media (max-width: 768px) {
      body { height: 100vh; overflow: hidden; }
      .header { padding: 6px 12px; font-size: 16px; }
      .metrics-bar {
        padding: 4px 12px;
        gap: 12px;
        font-size: 10px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .metric { gap: 4px; }
      .main-container {
        flex-direction: column;
        height: calc(100vh - 70px);
      }
      .map-container {
        flex: 0 0 50%;
        min-height: 200px;
        border-bottom: 1px solid #1e3a8a;
      }
      .sidebar {
        flex: 1;
        width: 100%;
        border-left: none;
        border-top: 1px solid #1e3a8a;
        max-height: 50%;
      }
      .sidebar-header { padding: 10px; }
      .tabs {
        gap: 2px;
        margin-bottom: 8px;
      }
      .tab {
        padding: 3px 6px;
        font-size: 9px;
      }
      .filter-label { font-size: 9px; margin-bottom: 4px; }
      .event-types { grid-template-columns: 1fr 1fr; gap: 3px; }
      .event-type-btn { padding: 2px 4px; font-size: 8px; }
      .event-counter { font-size: 8px; margin-top: 4px; }
      .events-content { padding: 8px; }
      .event-card { padding: 6px; margin-bottom: 6px; }
      .event-header { margin-bottom: 3px; }
      .event-type { font-size: 9px; }
      .event-time { font-size: 8px; }
      .event-title { font-size: 10px; margin-bottom: 3px; }
      .event-description { font-size: 9px; margin-bottom: 4px; }
      .event-meta { font-size: 8px; }
      .item-name { font-size: 10px; }
      .item-risk { font-size: 8px; }
      .metric-value { font-size: 10px; }
    }

    /* Tablet (Portrait) */
    @media (min-width: 481px) and (max-width: 768px) {
      .sidebar { width: 45%; }
      .tabs { gap: 3px; }
    }

    /* Medium screens (Tablet Landscape / Small Laptops) */
    @media (min-width: 769px) and (max-width: 1024px) {
      .sidebar { width: 280px; }
      .tabs { gap: 4px; }
      .metrics-bar { gap: 16px; }
      .event-card { padding: 7px; margin-bottom: 7px; }
    }

    /* Large screens (Desktop Laptops) */
    @media (min-width: 1025px) {
      .header { padding: 10px 18px; font-size: 20px; }
      .metrics-bar { gap: 32px; padding: 8px 18px; }
      .sidebar { width: 300px; }
      .main-container { flex-direction: row; }
      .map-container { flex: 1; }
      .event-card { padding: 10px; margin-bottom: 10px; }
    }

    /* Extra large screens (4K monitors) */
    @media (min-width: 1600px) {
      .sidebar { width: 350px; }
      .event-card { padding: 12px; margin-bottom: 12px; }
      .event-title { font-size: 13px; }
      .event-description { font-size: 12px; }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .tab, .event-type-btn, .event-card, .country-item, .resource-item {
        padding: 8px 10px;
        min-height: 44px;
      }
      .event-card { min-height: 50px; }
    }

    /* Landscape orientation (mobile) */
    @media (max-height: 500px) and (orientation: landscape) {
      .header { padding: 4px 12px; font-size: 14px; }
      .metrics-bar { padding: 3px 12px; gap: 12px; font-size: 10px; }
      .main-container { height: calc(100vh - 50px); }
      .sidebar { max-height: 100%; }
    }

    /* Responsive sidebar toggle visibility */
    @media (max-width: 768px) {
      .sidebar { position: relative; }
    }

    /* Scrollbar styling for better mobile experience */
    @media (max-width: 768px) {
      .events-content { scrollbar-width: thin; scrollbar-color: #1e3a8a #0a1929; }
      .events-content::-webkit-scrollbar { width: 4px; }
      .events-content::-webkit-scrollbar-track { background: #0a1929; }
      .events-content::-webkit-scrollbar-thumb { background: #1e3a8a; border-radius: 2px; }
    }
  </style>
</head>
 
<body>
  <div class="header">üåç Geopolitical Risk Tracker</div>
 
  <div class="metrics-bar">
    <div class="metric"><span>GPR Index:</span><span class="metric-value" id="gprValue">45.2</span></div>
    <div class="metric"><span>WUI:</span><span class="metric-value" id="wuiValue">52.8</span></div>
    <div class="metric"><span>BGR:</span><span class="metric-value" id="bgrValue">38.9</span></div>
    <div class="metric"><span>Last Update:</span><span class="metric-value" id="lastUpdate">--:--</span></div>
  </div>
 
  <div class="main-container">
    <div class="map-container"><div id="map"></div></div>
 
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('live')">Live Feed</button>
          <button class="tab" onclick="switchTab('countries')">Countries</button>
          <button class="tab" onclick="switchTab('resources')">Resources</button>
          <button class="tab" onclick="switchTab('shipping')">Shipping</button>
        </div>
 
        <div id="liveTabHeader" class="tab-header">
          <div class="filter-section">
            <div class="filter-label">Filter by event type:</div>
            <div class="event-types" id="eventTypes"></div>
            <div class="event-counter" id="eventCounter">Loading events...</div>
          </div>
        </div>
      </div>
 
      <div class="events-content">
        <!-- Live Feed -->
        <div id="liveContent" class="tab-content active">
          <div id="eventsContainer"><div class="loading">Loading live events...</div></div>
        </div>
 
        <!-- Countries -->
        <div id="countriesContent" class="tab-content">
          <div id="countriesContainer"></div>
        </div>
 
        <!-- Resources -->
        <div id="resourcesContent" class="tab-content">
          <div id="resourcesContainer"></div>
        </div>
 
        <!-- Shipping -->
        <div id="shippingContent" class="tab-content">
          <div id="shippingContainer"></div>
        </div>
      </div>
    </div>
  </div>
 
  <!-- Leaflet + MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
 
  <script>
    // ===================== RESPONSIVE DETECTION & HANDLING =====================
    let isMobile = window.innerWidth <= 768;
    let currentOrientation = window.innerHeight > window.innerWidth ? 'portrait' : 'landscape';

    function updateResponsiveState() {
      const wasMobile = isMobile;
      isMobile = window.innerWidth <= 768;
      const newOrientation = window.innerHeight > window.innerWidth ? 'portrait' : 'landscape';
      
      if (wasMobile !== isMobile || currentOrientation !== newOrientation) {
        currentOrientation = newOrientation;
        if (map) {
          setTimeout(() => map.invalidateSize(), 100);
        }
      }
    }

    // Detect orientation change and resize
    window.addEventListener('resize', updateResponsiveState);
    window.addEventListener('orientationchange', () => {
      updateResponsiveState();
      if (map) setTimeout(() => map.invalidateSize(), 250);
    });

    // Handle visibility for mobile devices
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && map) {
        setTimeout(() => map.invalidateSize(), 100);
      }
    });

    // ===================== Event types (UI keys) =====================
    const EVENT_TYPES = {
      'Conflict':   { color: '#EF4444' },
      'Sanctions':  { color: '#F59E0B' },
      'Trade':      { color: '#10B981' },
      'Resources':  { color: '#8B5CF6' },
      'Political':  { color: '#F97316' },
      'Economic':   { color: '#06B6D4' }
    };
 
    // ===================== Event colors for pulsing =====================
    const EVENT_TYPE_COLORS = {
      'Tariffs': '#F59E0B',
      'Trade Ban': '#EF4444',
      'Nationalization': '#8B5CF6',
      'Military Tension': '#F97316',
      'War': '#DC2626',
      'Sanctions': '#EF4444',
      "Coup d'Etat": '#DC2626',
      'Terrorism': '#991B1B',
      'Port Congestion': '#0891B2',
      'Climate Anomaly': '#059669',
      // Map UI categories to pulse color too
      'Conflict': '#DC2626',
      'Trade': '#F59E0B',
      'Resources': '#8B5CF6',
      'Political': '#F97316',
      'Economic': '#06B6D4'
    };
    function getEventColor(type) {
      return EVENT_TYPE_COLORS[type] || '#64748B';
    }
 
    // ===================== State =====================
    let map;
    let feedData = [];
    let activeEventTypes = Object.keys(EVENT_TYPES);
    let countryMarkersLayer = L.layerGroup();
    const codeToMarker = {};         // ISO3 -> circleMarker
    const nameToCode = {};           // "United States" -> "USA"
    const titleSeen = new Set();     // Dedup by title
 
    // ===================== Feeds =====================
    const RSS_FEEDS = [
      'http://data.gdeltproject.org/gdeltv3/gal/feed.rss',
      'https://www.reuters.com/rssFeed/worldNews',
      'https://feeds.reuters.com/reuters/businessNews',
      'https://feeds.reuters.com/Reuters/PoliticsNews',
      'https://www.defensenews.com/arc/outboundfeeds/rss/',
      'https://breakingdefense.com/feed/',
      'https://container-news.com/feed',
      'https://foreignpolicy.com/feed/',
      'https://www.crisisgroup.org/rss.xml',
      'https://www.bruegel.org/rss.xml',
      'https://www.piie.com/rss/update.xml',
      'https://www.aljazeera.com/xml/rss/all.xml',
      'https://www.mining.com/feed/',
      'https://www.oilprice.com/rss/main',
      'https://www.ft.com/rss/home',
      'https://www.imf.org/en/News/RSS',
      'https://www.worldbank.org/en/news/rss',
      'https://splash247.com/feed/'
    ];
 
    // ===================== Country risk seeds =====================
    const COUNTRY_RISKS = {
      // (same content you provided; trimmed here for brevity)
      'USA': { name: 'United States', risk: 3.0, lat: 37.0902, lng: -95.7129 },
      'CAN': { name: 'Canada', risk: 2.0, lat: 56.1304, lng: -106.3468 },
      'MEX': { name: 'Mexico', risk: 5.0, lat: 23.6345, lng: -102.5528 },
      'BRA': { name: 'Brazil', risk: 4.0, lat: -14.2350, lng: -51.9253 },
      'ARG': { name: 'Argentina', risk: 5.0, lat: -38.4161, lng: -63.6167 },
      'CHL': { name: 'Chile', risk: 3.0, lat: -35.6751, lng: -71.5430 },
      'COL': { name: 'Colombia', risk: 5.0, lat: 4.5709, lng: -74.2973 },
      'PER': { name: 'Peru', risk: 5.0, lat: -9.1900, lng: -75.0152 },
      'VEN': { name: 'Venezuela', risk: 8.0, lat: 6.4238, lng: -66.5897 },
      'ECU': { name: 'Ecuador', risk: 5.0, lat: -1.8312, lng: -78.1834 },
      'BOL': { name: 'Bolivia', risk: 6.0, lat: -16.2902, lng: -63.5887 },
      'URY': { name: 'Uruguay', risk: 3.0, lat: -32.5228, lng: -55.7658 },
      'PRY': { name: 'Paraguay', risk: 5.0, lat: -23.4425, lng: -58.4438 },
      'CUB': { name: 'Cuba', risk: 6.0, lat: 21.5218, lng: -77.7812 },
      'GBR': { name: 'United Kingdom', risk: 3.0, lat: 55.3781, lng: -3.4360 },
      'FRA': { name: 'France', risk: 3.0, lat: 46.2276, lng: 2.2137 },
      'DEU': { name: 'Germany', risk: 3.0, lat: 51.1657, lng: 10.4515 },
      'ESP': { name: 'Spain', risk: 3.0, lat: 40.4637, lng: -3.7492 },
      'ITA': { name: 'Italy', risk: 4.0, lat: 41.8719, lng: 12.5674 },
      'POL': { name: 'Poland', risk: 4.0, lat: 51.9194, lng: 19.1451 },
      'SWE': { name: 'Sweden', risk: 3.0, lat: 60.1282, lng: 18.6435 },
      'NOR': { name: 'Norway', risk: 2.0, lat: 60.4720, lng: 8.4689 },
      'RUS': { name: 'Russia', risk: 7.0, lat: 61.5240, lng: 105.3188 },
      'UKR': { name: 'Ukraine', risk: 9.0, lat: 48.3794, lng: 31.1656 },
      'BLR': { name: 'Belarus', risk: 7.0, lat: 53.7098, lng: 27.9534 },
      'KAZ': { name: 'Kazakhstan', risk: 5.0, lat: 48.0196, lng: 66.9237 },
      'UZB': { name: 'Uzbekistan', risk: 6.0, lat: 41.3775, lng: 64.5853 },
      'TKM': { name: 'Turkmenistan', risk: 6.0, lat: 38.9697, lng: 59.5563 },
      'KGZ': { name: 'Kyrgyzstan', risk: 6.0, lat: 41.2044, lng: 74.7661 },
      'TJK': { name: 'Tajikistan', risk: 6.0, lat: 38.8610, lng: 71.2761 },
      'ARM': { name: 'Armenia', risk: 7.0, lat: 40.0691, lng: 45.0382 },
      'AZE': { name: 'Azerbaijan', risk: 6.0, lat: 40.1431, lng: 47.5769 },
      'GEO': { name: 'Georgia', risk: 6.0, lat: 42.3154, lng: 43.3569 },
      'MDA': { name: 'Moldova', risk: 6.0, lat: 47.4116, lng: 28.3699 },
      'TUR': { name: 'Turkey', risk: 6.0, lat: 38.9637, lng: 35.2433 },
      'ISR': { name: 'Israel', risk: 8.0, lat: 31.0461, lng: 34.8516 },
      'IRN': { name: 'Iran', risk: 7.0, lat: 32.4279, lng: 53.6880 },
      'SAU': { name: 'Saudi Arabia', risk: 6.0, lat: 23.8859, lng: 45.0792 },
      'IRQ': { name: 'Iraq', risk: 8.0, lat: 33.2232, lng: 43.6793 },
      'SYR': { name: 'Syria', risk: 9.0, lat: 34.8021, lng: 38.9968 },
      'LBN': { name: 'Lebanon', risk: 8.0, lat: 33.8547, lng: 35.8623 },
      'JOR': { name: 'Jordan', risk: 5.0, lat: 30.5852, lng: 36.2384 },
      'YEM': { name: 'Yemen', risk: 9.0, lat: 15.5527, lng: 48.5164 },
      'EGY': { name: 'Egypt', risk: 6.0, lat: 26.8206, lng: 30.8025 },
      'DZA': { name: 'Algeria', risk: 5.0, lat: 28.0339, lng: 1.6596 },
      'MAR': { name: 'Morocco', risk: 4.0, lat: 31.7917, lng: -7.0926 },
      'TUN': { name: 'Tunisia', risk: 5.0, lat: 33.8869, lng: 9.5375 },
      'LBY': { name: 'Libya', risk: 8.0, lat: 26.3351, lng: 17.2283 },
      'SDN': { name: 'Sudan', risk: 8.0, lat: 12.8628, lng: 30.2176 },
      'NGA': { name: 'Nigeria', risk: 7.0, lat: 9.0820, lng: 8.6753 },
      'ETH': { name: 'Ethiopia', risk: 7.0, lat: 9.1450, lng: 40.4897 },
      'KEN': { name: 'Kenya', risk: 6.0, lat: -0.0236, lng: 37.9062 },
      'TZA': { name: 'Tanzania', risk: 5.0, lat: -6.3690, lng: 34.8888 },
      'GHA': { name: 'Ghana', risk: 4.0, lat: 7.9465, lng: -1.0232 },
      'AGO': { name: 'Angola', risk: 6.0, lat: -11.2027, lng: 17.8739 },
      'ZAF': { name: 'South Africa', risk: 5.0, lat: -30.5595, lng: 22.9375 },
      'COD': { name: 'DR Congo', risk: 8.0, lat: -4.0383, lng: 21.7587 },
      'UGA': { name: 'Uganda', risk: 6.0, lat: 1.3733, lng: 32.2903 },
      'ZWE': { name: 'Zimbabwe', risk: 7.0, lat: -19.0154, lng: 29.1549 },
      'CHN': { name: 'China', risk: 5.0, lat: 35.8617, lng: 104.1954 },
      'JPN': { name: 'Japan', risk: 4.0, lat: 36.2048, lng: 138.2529 },
      'KOR': { name: 'South Korea', risk: 5.0, lat: 35.9078, lng: 127.7669 },
      'PRK': { name: 'North Korea', risk: 8.0, lat: 40.3399, lng: 127.5101 },
      'TWN': { name: 'Taiwan', risk: 7.0, lat: 23.6978, lng: 120.9605 },
      'IND': { name: 'India', risk: 5.0, lat: 20.5937, lng: 78.9629 },
      'PAK': { name: 'Pakistan', risk: 7.0, lat: 30.3753, lng: 69.3451 },
      'BGD': { name: 'Bangladesh', risk: 6.0, lat: 23.6850, lng: 90.3563 },
      'AFG': { name: 'Afghanistan', risk: 9.0, lat: 33.9391, lng: 67.7100 },
      'VNM': { name: 'Vietnam', risk: 4.0, lat: 14.0583, lng: 108.2772 },
      'THA': { name: 'Thailand', risk: 4.0, lat: 15.8700, lng: 100.9925 },
      'IDN': { name: 'Indonesia', risk: 5.0, lat: -0.7893, lng: 113.9213 },
      'MYS': { name: 'Malaysia', risk: 4.0, lat: 4.2105, lng: 101.9758 },
      'SGP': { name: 'Singapore', risk: 2.0, lat: 1.3521, lng: 103.8198 },
      'PHL': { name: 'Philippines', risk: 6.0, lat: 12.8797, lng: 121.7740 },
      'MMR': { name: 'Myanmar', risk: 8.0, lat: 21.9162, lng: 95.9560 },
      'KHM': { name: 'Cambodia', risk: 5.0, lat: 12.5657, lng: 104.9910 },
      'LAO': { name: 'Laos', risk: 5.0, lat: 19.8563, lng: 102.4955 },
      'AUS': { name: 'Australia', risk: 2.0, lat: -25.2744, lng: 133.7751 },
      'NZL': { name: 'New Zealand', risk: 2.0, lat: -40.9006, lng: 174.8860 }
    };
 
    // Build name->ISO3 map (basic, add common synonyms)
    Object.entries(COUNTRY_RISKS).forEach(([code, v]) => {
      nameToCode[v.name.toUpperCase()] = code;
    });
    nameToCode['UNITED STATES'] = 'USA';
    nameToCode['US'] = 'USA';
    nameToCode['U.S.'] = 'USA';
    nameToCode['AMERICA'] = 'USA';
    nameToCode['UK'] = 'GBR';
    nameToCode['UNITED KINGDOM'] = 'GBR';
    nameToCode['SOUTH KOREA'] = 'KOR';
    nameToCode['NORTH KOREA'] = 'PRK';
    nameToCode['DR CONGO'] = 'COD';
    nameToCode['DEMOCRATIC REPUBLIC OF CONGO'] = 'COD';
 
    function countryCodeFromName(n) {
      if (!n) return null;
      return nameToCode[(n || '').toUpperCase()] || null;
    }
 
    // ===================== Map init =====================
    function initMap() {
      map = L.map('map').setView([20, 0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap contributors ¬© CARTO', subdomains: 'abcd', maxZoom: 19
      }).addTo(map);
 
      Object.entries(COUNTRY_RISKS).forEach(([code, country]) => {
        const color = getRiskColor(country.risk);
        const marker = L.circleMarker([country.lat, country.lng], {
          radius: Math.max(5, country.risk),
          fillColor: color,
          color: color,
          weight: 2,
          opacity: 0.8,
          fillOpacity: 0.6
        }).bindPopup(`
          <div style="min-width: 300px; font-family: sans-serif;">
            <h3 style="margin: 0 0 8px 0; color: #1e3a8a;">${country.name}</h3>
            <div style="margin-bottom: 6px;"><strong>Risk Level:</strong>
              <span style="color: ${color}; font-weight: 600;">${country.risk}/10</span>
            </div>
            <div style="margin-bottom: 6px;"><strong>Investment Grade:</strong>
              ${country.risk >= 8 ? 'HIGH RISK' : country.risk >= 6 ? 'MODERATE RISK' : 'LOW-MODERATE RISK'}
            </div>
            <div style="margin-bottom: 6px;"><strong>Primary Risk:</strong> ${getPrimaryRisk(code, country.risk)}</div>
            <div style="margin-bottom: 6px;"><strong>Sectors Affected:</strong> ${getAffectedSectors(code, country.risk)}</div>
            <div style="margin-bottom: 6px;"><strong>Investment Outlook:</strong> ${getInvestmentOutlook(country.risk)}</div>
            <div style="margin-bottom: 6px;"><strong>Key Concerns:</strong> ${getKeyConcerns(code, country.risk)}</div>
            <div style="font-size: 10px; color: #666; margin-top: 8px; border-top: 1px solid #ddd; padding-top: 6px; font-style: italic;">
              Risk assessment based on geopolitical, economic, and security factors
            </div>
          </div>
        `);
 
        marker.options.countryCode = code;
        codeToMarker[code] = marker;
        countryMarkersLayer.addLayer(marker);
      });
 
      countryMarkersLayer.addTo(map);
    }
 
    // Risk colors
    function getRiskColor(risk) {
      if (risk >= 8) return '#EF4444';
      if (risk >= 6) return '#F59E0B';
      if (risk >= 4) return '#EAB308';
      return '#22C55E';
    }
 
    // Risk texts (unchanged)
    function getPrimaryRisk(code, risk) {
      const highRiskCountries = {
        'VEN': 'Political instability, hyperinflation',
        'SYR': 'Active conflict, civil war',
        'UKR': 'Active conflict, territorial disputes',
        'AFG': 'Political instability, terrorism',
        'YEM': 'Civil war, humanitarian crisis',
        'LBY': 'Political fragmentation, militia conflicts',
        'IRQ': 'Sectarian tensions, terrorism',
        'ISR': 'Geopolitical tensions, security threats',
        'IRN': 'Sanctions, regional tensions',
        'PRK': 'Nuclear tensions, sanctions',
        'RUS': 'Sanctions, geopolitical isolation',
        'MMR': 'Military rule, civil unrest',
        'COD': 'Political instability, resource conflicts'
      };
      if (highRiskCountries[code]) return highRiskCountries[code];
      if (risk >= 7) return 'Nationalization risk, regulatory uncertainty';
      if (risk >= 5) return 'Political volatility, policy changes';
      return 'Stable with moderate monitoring';
    }
    function getAffectedSectors(code, risk) {
      const resourceRich = ['RUS', 'VEN', 'IRN', 'IRQ', 'SAU', 'COD', 'AGO'];
      const manufacturing = ['CHN', 'VNM', 'THA', 'MEX', 'POL'];
      const financial = ['USA', 'GBR', 'SGP', 'CHN', 'JPN'];
      if (resourceRich.includes(code)) return 'Oil & Gas, Mining, Energy';
      if (manufacturing.includes(code)) return 'Manufacturing, Supply Chain, Trade';
      if (financial.includes(code)) return 'Financial Services, Tech, Real Estate';
      if (risk >= 7) return 'All sectors - high caution';
      if (risk >= 5) return 'Infrastructure, Resources, Banking';
      return 'Technology, Services, Consumer';
    }
    function getInvestmentOutlook(risk) {
      if (risk >= 8) return 'AVOID - Extreme risk environment';
      if (risk >= 6) return 'CAUTIOUS - High due diligence required';
      if (risk >= 4) return 'SELECTIVE - Sector-specific opportunities';
      return 'FAVORABLE - Stable investment climate';
    }
    function getKeyConcerns(code, risk) {
      const concerns = {
        'VEN': 'Hyperinflation, asset seizures',
        'SYR': 'Ongoing conflict, sanctions',
        'UKR': 'War damage, reconstruction risks',
        'RUS': 'Western sanctions, currency volatility',
        'IRN': 'International sanctions, SWIFT restrictions',
        'CHN': 'Regulatory changes, US tensions',
        'USA': 'Policy shifts, debt levels',
        'TUR': 'Currency instability, inflation'
      };
      if (concerns[code]) return concerns[code];
      if (risk >= 7) return 'Expropriation, capital controls';
      if (risk >= 5) return 'Regulatory changes, currency risk';
      return 'Market volatility, sector-specific risks';
    }
 
    // ===================== Event type buttons (fixed toggle) =====================
    function initEventTypes() {
      const container = document.getElementById('eventTypes');
      container.innerHTML = '';
      Object.entries(EVENT_TYPES).forEach(([type]) => {
        const button = document.createElement('button');
        button.className = 'event-type-btn active';
        button.textContent = type;
        button.dataset.eventType = type;
        button.onclick = () => toggleEventType(type, button);
        container.appendChild(button);
      });
      updateEventCounter();
    }
 
    function toggleEventType(type, btnEl) {
      const idx = activeEventTypes.indexOf(type);
      if (idx > -1) {
        activeEventTypes.splice(idx, 1);
        btnEl?.classList.remove('active');
      } else {
        activeEventTypes.push(type);
        btnEl?.classList.add('active');
      }
      renderEventFeedWithSync();
    }
    // ===================== ULTRA-STRICT FILTERING - Only 8 Critical Event Types =====================
    const CRITICAL_KEYWORDS = {
      'War': ['war', 'conflict', 'military action', 'armed conflict', 'battle', 'combat', 'fighting', 'attack', 'strike', 'invasion', 'military operation'],
      'Sanctions': ['sanction', 'sanctions', 'embargo', 'trade ban', 'restrictions', 'penalty', 'ban'],
      'Tariffs': ['tariff', 'tariffs', 'duties', 'import duties', 'export duties', 'trade tax'],
      'Trade Ban': ['trade ban', 'export ban', 'import ban', 'export control', 'trade restriction', 'export restriction'],
      'Export Control': ['export control', 'technology ban', 'chip ban', 'semiconductor ban', 'dual-use', 'restricted export'],
      'Climate Anomaly': ['climate crisis', 'climate anomaly', 'extreme weather', 'heatwave', 'drought', 'flood', 'drought crisis', 'climate disaster'],
      'Port Congestion': ['port congestion', 'port strike', 'port closure', 'shipping delay', 'vessel congestion', 'terminal shutdown'],
      'Conflict': ['military tension', 'border conflict', 'territorial dispute', 'mobilization', 'military buildup', 'nuclear threat', 'missile test']
    };
   
    function isRelevantEvent(title, description) {
      const text = `${title} ${description}`.toLowerCase();
      for (const [category, keywords] of Object.entries(CRITICAL_KEYWORDS)) {
        if (keywords.some(k => text.includes(k))) {
          return true;
        }
      }
      return false;
    }
   
    function categorizeEvent(title, description) {
      const text = (title + ' ' + description).toLowerCase();
      for (const [category, keywords] of Object.entries(CRITICAL_KEYWORDS)) {
        if (keywords.some(k => text.includes(k))) {
          return category;
        }
      }
      return 'Conflict';
    }
   
    // ===================== Feed pipeline =====================
    function stripHtml(s='') {
      const div = document.createElement('div'); div.innerHTML = s; return (div.textContent || div.innerText || '').trim();
    }
 
    function categorizeEvent(title, description) {
      const text = (title + ' ' + description).toLowerCase();
      const keywords = {
        'Conflict':  ['war','military','conflict','attack','violence','terrorism','battle','missile','troop'],
        'Sanctions': ['sanction','embargo','restriction','ban'],
        'Trade':     ['trade','tariff','export','import',],
        'Resources': ['oil','gas','gold','copper','lithium', 'uranium','mining','energy','commodity'],
        'Economic':  ['economy','market','financial','gdp','inflation','investment','bank','currency']
      };
      for (const [cat, terms] of Object.entries(keywords)) {
        if (terms.some(t => text.includes(t))) return cat;
      }
      return 'Political';
    }
 
    function generateImplication(title, description, type) {
      const implications = {
        'Conflict':  ['Defense: Budget increase','Oil: Price volatility','Gold: Safe haven demand'],
        'Sanctions': ['Trade: Flow disruption','Energy: Supply risk','Banking: Access limited'],
        'Trade':     ['Commodities: Price impact','Currency: Exchange volatility','Exports: Volume change'],
        'Resources': ['Mining: Production risk','Energy: Supply concern','Metals: Price surge'],
        'Political': ['Markets: Uncertainty rise','Investment: Risk assessment','Currency: Volatility'],
        'Economic':  ['GDP: Growth impact','Inflation: Pressure build','Markets: Reaction expected']
      };
      const arr = implications[type] || implications['Economic'];
      return arr[Math.floor(Math.random() * arr.length)];
    }
 
    function extractCountry(title, description) {
      const candidates = [
        'United States','US','USA','America','China','Russia','Ukraine','Iran','Israel','India',
        'Japan','Germany','France','United Kingdom','UK','Brazil','Saudi Arabia','Turkey','Taiwan',
        'South Korea','North Korea','Egypt','Nigeria','Ethiopia','Kenya','Ghana','DR Congo','Congo',
        'Pakistan','Bangladesh','Afghanistan','Vietnam','Thailand','Indonesia','Malaysia','Singapore','Philippines',
        'Myanmar','Cambodia','Laos','Morocco','Algeria','Tunisia','Libya','Sudan','Venezuela','Peru','Chile','Argentina','Mexico'
      ];
      const text = `${title} ${description}`;
      for (const c of candidates) {
        if (text.includes(c)) return c;
      }
      return 'Global';
    }
 
    function getSourceName(url) {
      if (url.includes('gdelt')) return 'GDELT';
      if (url.includes('defensenews')) return 'Defense News';
      if (url.includes('foreignpolicy')) return 'Foreign Policy';
      if (url.includes('aljazeera')) return 'Al Jazeera';
      if (url.includes('crisisgroup')) return 'Crisis Group';
      if (url.includes('reuters')) return 'Reuters';
      return 'News Source';
    }
 
    async function fetchFeeds() {
      try {
        if (feedData.length === 0) {
          document.getElementById('eventsContainer').innerHTML = '<div class="loading">Connecting to live feeds...</div>';
        }
        const proxy = 'https://api.allorigins.win/raw?url=';
        const tasks = RSS_FEEDS.slice(0, 8).map(async (url) => {
          try {
            const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout')), 5000));
            const res = await Promise.race([fetch(proxy + encodeURIComponent(url)), timeout]);
            if (!res.ok) throw new Error('Fetch failed');
            const txt = await res.text();
            return parseFeed(txt, url);
          } catch { return []; }
        });
 
        const results = await Promise.all(tasks);
        const batch = results.flat();
 
        // Dedup by title and enforce relevance
        const newOnes = [];
        for (const e of batch) {
          if (!titleSeen.has(e.title)) {
            titleSeen.add(e.title);
            newOnes.push(e);
          }
        }
 
        if (newOnes.length) {
          // New on top, cap to 500
          feedData = [...newOnes, ...feedData]
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
            .slice(0, 500);
 
          renderEventFeedWithSync();
 
          // Pulse countries for highest-priority events per country
          const byCountry = {};
          newOnes.forEach(e => {
            const code = countryCodeFromName(e.country);
            if (!code) return;
            if (!byCountry[code] || e.riskLevel > byCountry[code].riskLevel) {
              byCountry[code] = e;
            }
          });
          Object.entries(byCountry).forEach(([code, ev]) => {
            highlightCountryOnMap(code, ev.type, ev.riskLevel);
          });
        }
 
        updateMetrics();
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
      } catch (err) {
        if (feedData.length === 0) {
          document.getElementById('eventsContainer').innerHTML = '<div class="no-events">Connecting... Please wait</div>';
        }
      }
    }
 
    function parseFeed(xmlText, sourceUrl) {
      try {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        if (xmlDoc.getElementsByTagName('parsererror').length > 0) return [];
        const items = xmlDoc.getElementsByTagName('item');
        const out = [];
        for (let i = 0; i < Math.min(items.length, 15); i++) {
          const it = items[i];
          const title = it.getElementsByTagName('title')[0]?.textContent || '';
          const description = it.getElementsByTagName('description')[0]?.textContent || '';
          const pubDate = it.getElementsByTagName('pubDate')[0]?.textContent || '';
 
          const cleanTitle = stripHtml(title).slice(0, 140);
          const cleanDesc  = stripHtml(description).slice(0, 260);
 
          if (cleanTitle && isRelevantEvent(cleanTitle, cleanDesc)) {
            const type = categorizeEvent(cleanTitle, cleanDesc);
            const countryName = extractCountry(cleanTitle, cleanDesc);
            out.push({
              id: Date.now() + Math.random(),
              title: cleanTitle,
              description: cleanDesc,
              type,
              country: countryName,
              riskLevel: Math.max(3, Math.min(9, Math.floor(Math.random()*7)+3)),
              timestamp: pubDate || new Date().toISOString(),
              implication: generateImplication(cleanTitle, cleanDesc, type),
              source: getSourceName(sourceUrl)
            });
          }
        }
        return out;
      } catch { return []; }
    }
 
    // ===================== Event rendering =====================
    function getEventIcon(type) {
      const icons = {
        'Conflict': '‚öîÔ∏è', 'Sanctions': 'üîí', 'Trade': 'üìä',
        'Resources': 'üíé', 'Political': 'üèõÔ∏è', 'Economic': 'üíµ'
      };
      return icons[type] || 'üì∞';
    }
 
    function updateEventCounter() {
      const total = feedData.length;
      const filtered = feedData.filter(e => activeEventTypes.includes(e.type)).length;
      document.getElementById('eventCounter').textContent = `${filtered} of ${total} events`;
    }
 
    function updateEventDisplay() {
      const container = document.getElementById('eventsContainer');
      const filteredEvents = feedData.filter(e => activeEventTypes.includes(e.type));
 
      if (filteredEvents.length === 0) {
        container.innerHTML = `
          <div class="text-center" style="padding: 32px 0; color: #6B7280;">
            <div style="font-size: 12px; margin-bottom: 8px;">No events match selected types</div>
            <button onclick="setAllEventTypes(true)" style="font-size: 10px; color: #60A5FA; background: none; border: none; cursor: pointer; text-decoration: underline;">
              Show all event types
            </button>
          </div>`;
        return;
      }
 
      container.innerHTML = filteredEvents.map(event => {
        const riskColor = getRiskColor(event.riskLevel);
        const backgroundColor = `${riskColor}15`;
        const code = countryCodeFromName(event.country) || '';
 
        return `
          <div class="event-card"
               data-country-code="${code}"
               data-event-type="${event.type}"
               data-risk-level="${event.riskLevel}"
               style="background-color: ${backgroundColor}; border-color: #475569;">
            <div class="event-header">
              <div style="display:flex; align-items:center; gap:6px;">
                <span style="font-size: 14px;">${getEventIcon(event.type)}</span>
                <span class="event-type" style="color:${riskColor}; font-weight:600;">${event.type}</span>
              </div>
              <span class="event-time">${new Date(event.timestamp).toLocaleTimeString()}</span>
            </div>
            <div class="event-title" style="color:#FFFFFF; font-weight:600; margin-bottom:4px;">${event.title}</div>
            <div class="event-description" style="color:#AAB7B8; margin-bottom:6px;">${event.description}</div>
            <div class="event-meta">
              <span class="country-name" style="color:#FFFFFF; font-weight:500;">${event.country}</span>
              <div style="display:flex; align-items:center; gap:4px;">
                <span style="color:#6B7280;">Risk:</span>
                <span style="color:${riskColor}; font-weight:600;">${event.riskLevel}</span>
              </div>
            </div>
            ${event.implication ? `
              <div class="event-impact">
                <div style="font-size:9px;">
                  <span class="impact-label" style="color:#6B7280;">Impact: </span>
                  <span class="impact-text" style="color:#F59E0B; font-weight:500;">${event.implication}</span>
                </div>
              </div>` : ''}
          </div>`;
      }).join('');
    }
 
    function setupEventCardHandlers() {
      document.querySelectorAll('[data-country-code]').forEach(card => {
        card.addEventListener('click', () => {
          const code = card.getAttribute('data-country-code');
          const type = card.getAttribute('data-event-type') || 'Political';
          const risk = parseInt(card.getAttribute('data-risk-level') || '5', 10);
          if (code) highlightCountryOnMap(code, type, risk);
        });
      });
    }
 
    function renderEventFeedWithSync() {
      updateEventDisplay();
      setupEventCardHandlers();
      updateEventCounter();
    }
 
    // ===================== Event ‚Üí Map sync (pulsing) =====================
    function highlightCountryOnMap(countryCode, eventType, riskLevel = 5) {
      const marker = codeToMarker[countryCode];
      if (!marker) return;
 
      const eventColor = getEventColor(eventType);
      const fallbackColor = getRiskColor(COUNTRY_RISKS[countryCode]?.risk || riskLevel);
 
      try {
        marker.setStyle({ fillColor: eventColor, color: eventColor, fillOpacity: 0.85, weight: 2.5 });
        if (marker._path) marker._path.classList.add('country-pulse');
 
        map.setView(marker.getLatLng(), 5, { animate: true });
      } catch {}
 
      setTimeout(() => {
        try {
          marker.setStyle({ fillColor: fallbackColor, color: fallbackColor, fillOpacity: 0.6, weight: 2 });
          if (marker._path) marker._path.classList.remove('country-pulse');
        } catch {}
      }, 5000);
    }

    // ===================== Metrics =====================
    function updateMetrics() {
      if (feedData.length === 0) {
        document.getElementById('gprValue').textContent = '50.0';
        document.getElementById('wuiValue').textContent = '50.0';
        document.getElementById('bgrValue').textContent = '50.0';
        return;
      }
      const avgRisk = feedData.reduce((s, e) => s + e.riskLevel, 0) / feedData.length;
      const base = Math.min(100, Math.max(0, (avgRisk / 10) * 100));
      const noise = () => (Math.random() * 5 - 2.5);
      document.getElementById('gprValue').textContent = base.toFixed(1);
      document.getElementById('wuiValue').textContent = (base + noise()).toFixed(1);
      document.getElementById('bgrValue').textContent = (base + noise()).toFixed(1);
    }
 
    // ===================== Tabs =====================
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
 
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tabName + 'Content').classList.add('active');
 
      const liveHeader = document.getElementById('liveTabHeader');
      liveHeader.style.display = (tabName === 'live') ? 'block' : 'none';
 
      if (tabName === 'countries') loadCountriesTab();
      else if (tabName === 'resources') loadResourcesTab();
      else if (tabName === 'shipping') loadShippingTab();
    }
 
    function loadCountriesTab() {
      const container = document.getElementById('countriesContainer');
      container.innerHTML = Object.entries(COUNTRY_RISKS).map(([code, country]) => `
        <div class="country-item">
          <div class="item-name">${country.name}</div>
          <div class="item-risk">
            <span class="risk-label">Risk Level:</span>
            <span class="risk-value" style="color:${getRiskColor(country.risk)}">${country.risk}/10</span>
          </div>
        </div>`).join('');
    }
 
    function loadResourcesTab() {
      const resources = [
        { name: 'Crude Oil', risk: 7.2, impact: 'Supply concerns' },
        { name: 'Natural Gas', risk: 6.8, impact: 'Price volatility' },
        { name: 'Gold', risk: 4.1, impact: 'Safe haven demand' },
        { name: 'Copper', risk: 5.9, impact: 'Industrial demand' },
        { name: 'Lithium', risk: 6.5, impact: 'EV market growth' },
        { name: 'Wheat', risk: 7.8, impact: 'Food security' }
      ];
      const container = document.getElementById('resourcesContainer');
      container.innerHTML = resources.map(r => `
        <div class="resource-item">
          <div class="item-name">${r.name}</div>
          <div class="item-risk">
            <span class="risk-label">Risk:</span>
            <span class="risk-value" style="color:${getRiskColor(r.risk)}">${r.risk}/10</span>
          </div>
          <div style="font-size:9px; color:#6B7280; margin-top:2px;">${r.impact}</div>
        </div>`).join('');
    }
 
    function loadShippingTab() {
      const ports = [
        { name: 'Suez Canal', congestion: 'High', risk: 8.1 },
        { name: 'Singapore', congestion: 'Moderate', risk: 4.2 },
        { name: 'Los Angeles', congestion: 'High', risk: 6.8 },
        { name: 'Rotterdam', congestion: 'Low', risk: 3.1 },
        { name: 'Shanghai', congestion: 'Moderate', risk: 5.4 },
        { name: 'Panama Canal', congestion: 'High', risk: 7.3 }
      ];
      const container = document.getElementById('shippingContainer');
      container.innerHTML = ports.map(p => `
        <div class="resource-item">
          <div class="item-name">${p.name}</div>
          <div class="item-risk">
            <span class="risk-label">Congestion:</span>
            <span class="risk-value">${p.congestion}</span>
          </div>
          <div style="font-size:9px; color:#6B7280; margin-top:2px;">Risk: ${p.risk}/10</div>
        </div>`).join('');
    }
 
    // ===================== Live init =====================
    function setAllEventTypes(active) {
      activeEventTypes = active ? [...Object.keys(EVENT_TYPES)] : [];
      document.querySelectorAll('.event-type-btn').forEach(btn => {
        btn.classList.toggle('active', active);
      });
      renderEventFeedWithSync();
    }
 
    function init() {
      initMap();
      initEventTypes();
 
      // Initial load + refresh every 60s
      fetchFeeds();
      setInterval(fetchFeeds, 60 * 1000);
 
      // Refresh when tab becomes visible
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) fetchFeeds();
      });
    }
 
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
